jQuery(document).ready(function(a){function b(b){this.step=b,this.pt=null,this.linked_pt_count=0,this.linked_pt_cur=0,this.total_posts=0,this.ppr=null,this.action=null,this.percentage_object=null,this.nonce=null,this.do_request=function(){var b=this;a.post(ajaxurl,{action:this.action,nonce:a("#rp4wp-ajax-nonce").val(),ppr:this.ppr,pt:this.pt,linked_pt_cur:this.linked_pt_cur},function(a){var c=new RegExp("^[0-9]+$");if(a=a.trim(),c.test(a)){var d=parseInt(a);b.do_progressbar(d),d>0?b.do_request():b.done()}else alert("Woops! Something went wrong while linking.\n\nResponse:\n\n"+a)})},this.done=function(){a("#progressbar").progressbar({value:100});var b=a("#rp4wp_admin_url").val()+"?page=rp4wp_install&pt="+this.pt+"&rp4wp_nonce="+this.nonce;b+=2===this.step&&this.linked_pt_cur<this.linked_pt_count?"&step="+this.step+"&cur="+(this.linked_pt_cur+1):"&step="+(this.step+1),window.location=b},this.do_progressbar=function(b){var c=this.total_posts-b;0>c&&(c=0),jQuery("#progress-done").html(c),jQuery("#progress-todo").html(b);var d=Math.round(c/this.total_posts*100);d>0&&(this.percentage_object.html(d+"%"),a("#progressbar").progressbar({value:d}))},this.init=function(){switch(this.pt=a("#rp4wp_post_type").val(),this.linked_pt_count=parseInt(a("#linked_pt_count").val()),this.linked_pt_cur=parseInt(a("#linked_pt_cur").val()),this.nonce=a("#rp4wp_nonce").val(),a("#progressbar").progressbar({value:!1}),this.percentage_object=jQuery("<span>"),a("#progressbar").find("div:first").append(this.percentage_object),this.do_progressbar(a("#rp4wp_posts_todo").val()),this.total_posts=a("#rp4wp_total_posts").val(),this.step){case 2:this.ppr=25,this.action="rp4wp_install_save_words";break;case 3:this.ppr=5,this.action="rp4wp_install_link_posts"}if(jQuery("#progress-container").show(),3==this.step){var b=this;a.post(ajaxurl,{action:"rp4wp_install_save_options",nonce:a("#rp4wp-ajax-nonce").val(),pt:this.pt,rel_amount:a("#rp4wp_related_posts_amount").val(),rp4wp_related_posts_age:a("#rp4wp_related_posts_age").val()},function(a){a=a.trim(),"success"==a?b.do_request():alert("Woops! Something went wrong while linking.\n\nResponse:\n\n"+a)})}else this.do_request()},this.init()}a.fn.rp4wp_install_pt_table=function(){this.editing=!1,this.available_post_type=a("#rp4wp-availabe_post_types").val().split(","),this.get_row_by_pt=function(b){var c=a(this).find("tr[rel="+b+"]");return c?c:null},this.get_linked_post_types=function(b){var c=new Array;return a.each(b.find("td.rp4wp-children ul li"),function(b,d){a(d).attr("id")&&c.push(a(d).attr("id"))}),c},this.get_available_post_types=function(a){for(var b=this.available_post_type.slice(),c=this.get_linked_post_types(this.get_row_by_pt(a)),d=new Array,e=0;e<b.length;e++){var f=c.indexOf(b[e]);-1==f&&d.push(b[e])}return d},this.disable_buttons=function(){a(this).find(".button").addClass("disabled")},this.enable_buttons=function(){a(this).find(".button").removeClass("disabled")},this.add_new_pt_button=function(b){var c=this,d=this.get_available_post_types(b.attr("rel"));0==b.find(".add-pt").length&&d.length>0&&b.find("td.rp4wp-children ul").append(a("<li>").addClass("add-pt").append(a("<span>").html("Add New Post Type")).click(function(){for(var e=a("<select>"),f=0;f<d.length;f++)e.append(a("<option>").val(d[f]).html(rp4wp_js[d[f]]));a(this).parent().append(a("<li>").addClass("new-pt").append(e).append(a("<a>").attr("href","javascript:;").addClass("add-pt-plus rp4wp-has-tip").attr("title",rp4wp_js.lbl_add_pt).html("+").click(function(){c.add_post_type(b,a(this).parent().find("select option:selected").val())}))),a(this).remove(),Tipped.create(".rp4wp-has-tip",{position:"top"})}))},this.add_post_type=function(b,c){var d=this;b.find(".new-pt").remove(),b.find("td.rp4wp-children ul").append(a("<li>").attr("id",c).addClass("edit").append(a("<span>").html(rp4wp_js[c])).append(a("<a>").addClass("remove-btn").click(function(){a(this).parent().remove(),d.add_new_pt_button(b)}))),this.add_new_pt_button(b)},this.edit_row=function(b){var c=this;this.editing=!0,this.disable_buttons();var d=this.get_row_by_pt(b);return d?(d.removeClass("inactive"),a.each(d.find("td.rp4wp-children ul li"),function(b,e){a(e).addClass("edit").append(a("<a>").addClass("remove-btn").click(function(){a(this).parent().remove(),c.add_new_pt_button(d)}))}),this.add_new_pt_button(d),d.find(".rp4wp-button .rp4wp-buttons-wrap").hide(),d.find(".rp4wp-button").append(a("<a>").addClass("button button-primary").addClass("rp4wp-btn-save rp4wp-has-tip").attr("href","javascript:;").attr("rel","save").attr("title",rp4wp_js.lbl_save).click(function(){c.save_row(b)})),void Tipped.create(".rp4wp-has-tip",{position:"top"})):void(this.editing=!1)},this.restore_row=function(b){var c=this.get_row_by_pt(b);c.find(".add-pt").remove(),c.find(".new-pt").remove(),a.each(c.find("td.rp4wp-children ul li"),function(b,c){a(c).removeClass("edit").find("a").remove()}),c.find("a[rel=save]").remove(),c.find(".rp4wp-button .rp4wp-buttons-wrap").show(),0===c.find("td.rp4wp-children ul li").length&&(c.addClass("inactive"),c.find(".rp4wp-buttons-wrap a.button[rel=delete]").remove())},this.save_row=function(b){this.restore_row(b),this.editing=!1,this.enable_buttons(),a.post(ajaxurl,{action:"rp4wp_install_set_post_types",parent:b,nonce:a("#rp4wp-ajax-nonce").val(),post_types:this.get_linked_post_types(this.get_row_by_pt(b))},function(c){"success"===c.result?!0===c.redirect&&(window.location=a("#rp4wp_admin_url").val()+"?page=rp4wp_install&pt="+b+"&step=2&rp4wp_nonce="+a("#rp4wp_nonce").val()):alert("Whoops! Something went wrong:\n\n"+c.error)})},this.generate_remove_button=function(){var b=this;return a("<a>").addClass("button").addClass("button-primary").addClass("rp4wp-btn-delete rp4wp-has-tip").attr("rel","delete").attr("href","javascript:;").attr("title",rp4wp_js.lbl_delete).click(function(){if(!1===b.editing){var c=a(this).closest("tr").attr("rel");b.edit_row(c);var d=b.get_row_by_pt(c);a.each(d.find("td.rp4wp-children ul li"),function(a,b){b.remove()}),b.save_row(c)}})},this.generate_relink_button=function(){var b=this;return a("<a>").addClass("button").addClass("button-primary").addClass("rp4wp-btn-relink rp4wp-has-tip").attr("rel","rerun").attr("title",rp4wp_js.lbl_relink).attr("href","javascript:;").click(function(){if(!1===b.editing){var c=a(this).closest("tr").attr("rel");a.post(ajaxurl,{action:"rp4wp_install_relink",parent:c,nonce:a("#rp4wp-ajax-nonce").val()},function(b){"success"===b.result?!0===b.redirect&&(window.location=a("#rp4wp_admin_url").val()+"?page=rp4wp_install&pt="+c+"&step=3&rp4wp_nonce="+a("#rp4wp_nonce").val()):alert("Whoops! Something went wrong:\n\n"+b.error)})}})},this.generate_reinstall_button=function(){var b=this;return a("<a>").addClass("button").addClass("button-primary").addClass("rp4wp-btn-reinstall rp4wp-has-tip").attr("rel","rerun").attr("title",rp4wp_js.lbl_reinstall).attr("href","javascript:;").click(function(){if(!1===b.editing){var c=a(this).closest("tr").attr("rel");a.post(ajaxurl,{action:"rp4wp_install_reinstall",parent:c,nonce:a("#rp4wp-ajax-nonce").val()},function(b){"success"===b.result?!0===b.redirect&&(window.location=a("#rp4wp_admin_url").val()+"?page=rp4wp_install&pt="+c+"&step=2&rp4wp_nonce="+a("#rp4wp_nonce").val()):alert("Whoops! Something went wrong:\n\n"+b.error)})}})},this.init=function(){var b=this;a.each(a(this).find("tr"),function(c,d){if(null!=a(d).attr("rel")){var e=a(d).attr("rel");a(d).find("a.button[rel=edit]").click(function(){!1===b.editing&&b.edit_row(e)}),b.get_linked_post_types(a(d)).length>0&&(a(d).find(".rp4wp-buttons-wrap").append(b.generate_relink_button()),a(d).find(".rp4wp-buttons-wrap").append(b.generate_reinstall_button()),a(d).find(".rp4wp-buttons-wrap").append(b.generate_remove_button()))}}),Tipped.create(".rp4wp-has-tip",{position:"top"})},this.init()};var c=a(".rp4wp-step").attr("rel");1==c?a(".rp4wp-table-pt-overview").rp4wp_install_pt_table():2==c?b(2):3==c&&a("#rp4wp-link-now").click(function(){b(3)})});